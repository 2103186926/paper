## Demo代码生成

@project03 首先我先讲解一下我的初始demo，project03文件夹中4个文件夹的作用，ast_to_json负责将python源码抽象成ast并且转成JSON格式；high_risk_tests是包含高危操作的一些测试文件；semantic_features是语义特征提取模块；structural_features是结构特征提取模块。接下来你将帮助我完成ast_to_json.py、semantic_feature_extractor.py、cfg_generator.py、structural_feature_extractor.py。

我的目标如下：我需要对用户提交的python源码进行静态分析，从而检测出代码中的高危操作。

我的思路如下：

1.先将用户提交的python源码文件转化成JSON格式的AST抽象语法树。

2.将得到的JSON格式的抽象语法树分别进行语义特征提取和结构特征提取。

​	2.1 语义特征提取：

​		（1）

​		（2）

​	2.2 结构特征提取：

​		（1）先将JSON格式的抽象语法树转成CFG控制流程图，再将CFG控制流程图转成像素为0到255的灰度图。

​		（2）将灰度图利用GIST算法看整体结构（比如纹理分布）并且利用SIFT算法抓局部细节（比如特殊斑点），获得融合后的图像特征。

3.将融合后的结构特征与语义特征进行PCA降维拼接特征。

接下来的每一次生成回答前，请先复述一遍我的需求再进行回答，让我确认你真正了解了我的话。





第一步：

ast_to_json.py - Python代码抽象语法树(AST)转JSON工具，

功能：将Python源代码解析为抽象语法树，并以JSON格式输出。

输入：Python源代码文件，

输出：JSON格式的语法树（包含节点类型、位置信息和层级关系）.



第二步：

semantic_feature_extractor.py - Python代码语义特征提取工具，

功能：

​	1.敏感函数统计：统计os/subprocess等模块调用次数 

​	2.代码模式分析：正则表达式匹配base64.b64decode等混淆操作 

​	3.生成语义特征向量。

输入：JSON格式的ast语法树，

默认输出：语义特征向量（JSON格式），可选输出：计算综合风险评分和生成详细的特征摘要。请帮我生成代码并加上注释，并给出详细的运行测试方法。



在第二步的基础上，在改版一下：

在ast基础上，提取一下操作码序列（如"mov, cmp, jmp..."）→N-gram词袋（300维）





第三步：

cfg_generator.py - 控制流程图(CFG)生成工具。

功能：

​	1.根据Python代码生成控制流程图(CFG) 

​	2.检测代码中的高危操作(eval/exec等)并在图中标记 

​	3.支持多种输出格式：NetworkX有向图对象和Graphviz的DOT文件和PNG图像文件。

输入：JSON格式的ast语法树，

输出：控制流程图(DOT格式或NetworkX对象)。请帮我生成代码并加上注释，并给出详细的运行测试方法。



第四步：

GIST_feature.py-GIST全局特征提取工具。

功能：

1. CFG图像化：使用Force Atlas布局算法进行节点定位，将CFG转换为256x256灰度图像，通过边缘密度映射生成像素亮度。
2. GIST全局特征提取：使用pyleargist库提取图像的GIST特征（256维），支持自定义方向数和块数。

输入：第三步生成的NetworkX图对象或DOT文件，

输出：GIST特征向量（pickle格式）



第五步：

FIST_feature.py-FIST局部特征提取工具。

功能：

1. CFG图像化：使用Force Atlas布局算法进行节点定位，将CFG转换为256x256灰度图像，通过边缘密度映射生成像素亮度。
2. FIST局部特征提取：使用simhash库提取图像的FIST特征（128维）

输入：第三步生成的NetworkX图对象或DOT文件，

输出：GIST特征向量（pickle格式）





第六步：

structural_feature_extractor.py - 控制流程图(CFG)结构特征提取工具。

功能：

​	1. CFG图像化：使用Force Atlas布局算法进行节点定位，将CFG转换为256x256灰度图像，通过边缘密度映射生成像素亮度。

​	2. GIST全局特征提取：使用pyleargist库提取图像的GIST特征，支持自定义方向数和块数。

​	3. SIFT局部特征提取：

​	4.将GIST全局特征与SIFT局部特征进行特征融合，得到融合后的图像特征。

输入：NetworkX图对象或DOT文件，

输出：CFG的灰度图像表示、GIST特征向量（pickle格式），SIFT局部特征。请帮我生成代码并加上注释，并给出详细的运行测试方法。



第五步：

PCA降维拼接特征

GIST(256)+SIFT(128)+N-gram(300)→684维向量





我需要对用户提交的python文件代码进行静态分析，从而检测出代码中的高危操作。

我的思路如下：
1.先将用户提交的python源码文件转化成JSON格式的AST抽象语法树。
2.将得到的JSON格式的抽象语法树分别进行语义特征提取和结构特征提取。
	2.1 语义特征提取：
	（1）根据Python代码生成控制流程图(CFG)。
	（2）敏感词频统计(eval/os模块调用)，并得到操作序列。
	（3）通过N-gram算法统计“高危操作”的常见搭配。
	（4）得到操作码语义特征。

1.敏感函数统计：统计os/subprocess等模块调用次数 

​	2.代码模式分析：正则表达式匹配base64.b64decode等混淆操作 

​	3.生成语义特征向量。

​	2.2 结构特征提取：

​	（1）根据Python代码生成控制流程图(CFG)。
​	（2）将CFG转换为256x256灰度图像。
​	（3）利用GIST算法对全局纹理特征提取。
​	（4）利用FIST算法对局部关键点特征提取。
​	（5）将全局纹理特征与局部关键点特征进行特征拼接，形成融合图像特征。

3.将融合后的图像特征与语义特征进行纵向拼接形成静态融合特征。

4.将静态融合特征输入BiLSTM网络进行训练。

5.最后得到分类结果。

请详细生成每一步的详细步骤，给出每一步的输入和输出格式。

接下来的每一次生成回答前，请先复述一遍我的需求再进行回答，让我确认你真正了解了我的话。





## 解释代码整个流程

Demo代码生成之后，先运行测试一遍整个流程，看能否跑通，这一步叫快速上手。

基本上能跑通，功能基本实现个7788了，然后在从头到尾好好理解以下代码，这一步叫手撕代码。

整个流程的代码理解个7788了，就开始要写文档总结实现流程和个人工作量了。



## 整理文档

总结实现流程，复盘工作量，
